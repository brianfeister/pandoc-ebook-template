\documentclass[
  fontsize=12pt,
]{scrbook}

% some basic instruments
\usepackage[onehalfspacing]{setspace}
\usepackage{blindtext}
\usepackage{etoolbox}

\usepackage[table]{xcolor}

% TikZ ftw!
\usepackage{tikz}
\usetikzlibrary{positioning}
\usetikzlibrary{patterns}

% TODO: sloppiness *must* be removed in production
\sloppy

% ============================================================= PAGE GEOMETRY ==

\usepackage[
  paperwidth=8.5in,
  paperheight=11in,
  twocolumn,
  columnsep=.2in,
  top=1in,
  inner=1in,
  outer=0.75in,
  bottom=1in,
  footskip=.5in,
  headsep=.25in,
]{geometry}

% General spacing settings

%\usepackage{setspace}
%\setstretch{}

%\setlength{\parindent}{0pt}
%\setlength{\parskip}{6pt plus 2pt minus 1pt}
%\setlength{\emergencystretch}{3em}  % prevent overfull lines

% IMPORTANT: remember to use this if lists are present
%\providecommand{\tightlist}{%
%  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% ====================================================================== MATH ==

%\usepackage{amssymb,amsmath}

% ===================================================================== FONTS ==

\usepackage{fontspec}

\setmainfont{PT Serif}
% \setmainfont
%   [Ligatures=TeX, % recommended
%    UprightFont={* Light},
%    ItalicFont={* Light Italic},
%    BoldFont={* Bold},
%    BoldItalicFont={* Bold Italic}]
%   {Merriweather}
% \setsansfont{Yana B}
\setsansfont
  [Ligatures=TeX, % recommended
   UprightFont={*},
   ItalicFont={*},
   BoldFont={*-Bold},
   BoldItalicFont={*-Bold}]
  {Cinzel}
\setmonofont{PT Sans}

% ================================================================== LANGUAGE ==

$if(language)$\usepackage[$language$]{babel}$endif$
$if(hyphenation)$\hyphenation{
$for(hyphenation)$
  $hyphenation$
$endfor$
}$endif$

%\usepackage{polyglossia}
%\setmainlanguage{english}

% ================================================================ HYPERLINKS ==

\usepackage[
  unicode=true,
%  breaklinks=true,
%  bookmarks=true,
%  pdfauthor={$author-meta$},
%  pdftitle={$title-meta$},
%  colorlinks=true,
%  citecolor=$if(citecolor)$$citecolor$$else$blue$endif$,
%  urlcolor=$if(urlcolor)$$urlcolor$$else$blue$endif$,
%  linkcolor=$if(linkcolor)$$linkcolor$$else$magenta$endif$,
%  pdfborder={0 0 0},
  hidelinks,
]{hyperref}

% don't use monospace font for urls
\urlstyle{same}

% =============================================================== PAGE LAYOUT ==

%\usepackage{fancyhdr}
%\pagestyle{fancy}
%\pagenumbering{arabic}
%\lhead{\itshape $title$}
%\chead{}
%\rhead{\itshape{\nouppercase{\leftmark}}}
%\lfoot{v $version$}
%\cfoot{}
%\rfoot{\thepage}

% ==================================================================== FLOATS ==

% allow b and h for table* and figure*
\usepackage{dblfloatfix}

% preserve order among starred and unstarred tables/figures
\usepackage{fixltx2e}

% enable H positioning and other stuff
\usepackage{float}

% ==================================================================== TABLES ==

% first we need to make pandoc output behave

%\usepackage{longtable}
\let\endhead\relax

%\usepackage{booktabs}
\let\toprule\hline
\let\bottomrule\hline
\let\midrule\hline

% and now the serious stuff

% breakable two-columns tables
\usepackage{xtab}

% essential for styling
\usepackage{array}

\rowcolors{1}{gray!50}{gray}
\renewcommand*{\arraystretch}{1.5}

% transparency trick: ! gets the fill while > gets the content
\newcolumntype{O}{
  !{\pgfsetfillopacity{.2}}
  >{\leavevmode\pgfsetfillopacity{1}}
}

% content alignment
\newcolumntype{J}{>{}}
\newcolumntype{L}{>{\raggedright\arraybackslash}}
\newcolumntype{C}{>{\centering\arraybackslash}}
\newcolumntype{R}{>{\raggedleft\arraybackslash}}

% instead of erasing separators with @{} just compensate for them
\newcolumntype{S}[2]{#1{\dimexpr#2\linewidth-2\tabcolsep\relax}}

% cell alignment
\newcolumntype{T}[1]{S{p}{#1}}
\newcolumntype{M}[1]{S{m}{#1}}
\newcolumntype{B}[1]{S{b}{#1}}

\NewDocumentCommand{\NextTableColumns}{m}{\newcolumntype{N}{#1}}

\NewDocumentCommand{\BreakingTable}{}{
  \renewenvironment{VariaTable}
    {\begin{xtabular*}{\linewidth}{N}}
    {\end{xtabular*}}
}

\NewDocumentCommand{\FloatingTable}{O{htb}}{
  \renewenvironment{VariaTable}
    {\begin{table}[#1]\begin{xtabular*}{\linewidth}{N}}
    {\end{xtabular*}\end{table}}
}

\NewDocumentCommand{\SpanningTable}{O{tbp}}{
  \renewenvironment{VariaTable}
    {\begin{table*}[#1]\begin{xtabular*}{\linewidth}{N}}
    {\end{xtabular*}\end{table*}}
}

\newenvironment{VariaTable}{}{}
\BreakingTable

% hook to reset table configuration after each use
\AfterEndEnvironment{VariaTable}{\BreakingTable}

% =================================================================== FIGURES ==

\NewDocumentCommand{\FloatingFigure}{O{htb}}{
  \renewenvironment{VariaFigure}
    {\figure[#1]}
    {\endfigure}
}

\NewDocumentCommand{\SpanningFigure}{O{tbp}}{
  \renewenvironment{VariaFigure}
    {\begin{figure*}[#1]}
    {\end{figure*}}
}

\newenvironment{VariaFigure}{}{}
\FloatingFigure

%% hook to reset figure configuration after each use
\AfterEndEnvironment{VariaFigure}{\FloatingFigure}

% Positioning keys for \AbsoluteFigure
\tikzset{
  center/.style={at=(current page.center)},
  top/.style={at=(current page.north), anchor=north, yshift={-1*#1}},
  left/.style={at=(current page.west), anchor=west, xshift={#1}},
  bottom/.style={at=(current page.south), anchor=south, yshift={#1}},
  right/.style={at=(current page.east), anchor=east, xshift={-1*#1}},
  top left/.style args={#1 and #2}{at=(current page.north west), anchor=north west, yshift={-1*#1}, xshift={#2}},
  bottom left/.style args={#1 and #2}{at=(current page.south west), anchor=south west, yshift={#1}, xshift={#2}},
  top right/.style args={#1 and #2}{at=(current page.north east), anchor=north east, yshift={-1*#1}, xshift={-1*#2}},
  bottom right/.style args={#1 and #2}{at=(current page.south east), anchor=south east, yshift={#1}, xshift={-1*#2}},
}

\NewDocumentCommand{\AbsoluteFigure}{O{}m}{
  \AddToShipoutPictureBG*{\tikz [overlay, remember picture] \node [center, #1, inner sep=0] {\includegraphics{#2}};}
}

% automagic picture resizing
\usepackage{graphicx,grffile}
\newsavebox\ltmcbox
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% ================================================================== CALLOUTS ==

\usepackage[framemethod=tikz]{mdframed}

\newmdenv[
  middlelinecolor=red,
  backgroundcolor=red!10,
  middlelinewidth=2pt,
  frametitle=Warning box,
]{CalloutWarning}

\newmdenv[
  middlelinecolor=green,
  backgroundcolor=green!10,
  middlelinewidth=2pt,
  roundcorner=10pt,
  frametitle=Example box,
]{CalloutExample}

\newmdenv[
  middlelinecolor=blue,
  backgroundcolor=blue!10,
  middlelinewidth=2pt,
  frametitle=Information box,
]{CalloutInformation}

% ================================================================ BACKGROUND ==

% temporary page color
\usepackage{pagecolor}
\pagecolor{yellow!30}

\usepackage{eso-pic}

% background image
\AddToShipoutPictureBG{
\tikz [overlay, remember picture] \node at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio]{paper-bg.jpg}};
% \tikz [overlay, remember picture] \draw [pattern=fivepointed stars,pattern color=orange!20] (current page.north west) rectangle (current page.south east);
}

% ================================================================= MICROTYPE ==

\usepackage{microtype}

% ============================================================= MAIN DOCUMENT ==

$if(title)$\title{$title$}$endif$
$if(author)$\author{$author$}$endif$
$if(date)$\date{$date$}$endif$

\begin{document}
\maketitle
\tableofcontents
$body$
\end{document}
