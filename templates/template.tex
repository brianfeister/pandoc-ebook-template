\documentclass[12pt]{report}

% some basic instruments
\usepackage{blindtext}
\usepackage{etoolbox}

% TODO: sloppiness *must* be removed in production
\sloppy

% ============================================================= PAGE GEOMETRY ==

\usepackage[
  letterpaper,
  margin=0.5in,
  twocolumn,
]{geometry}

% General spacing settings

%\usepackage{setspace}
%\setstretch{}

%\setlength{\parindent}{0pt}
%\setlength{\parskip}{6pt plus 2pt minus 1pt}
%\setlength{\emergencystretch}{3em}  % prevent overfull lines

% IMPORTANT: remember to use this if lists are present
%\providecommand{\tightlist}{%
%  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% ====================================================================== MATH ==

%\usepackage{amssymb,amsmath}

% ===================================================================== FONTS ==

\usepackage{fontspec}

\setmainfont{Droid Serif}
\setsansfont{Alegreya SC}
\setmonofont{Alegreya SC}

% ================================================================== LANGUAGE ==

\usepackage{polyglossia}
\setmainlanguage{english}

% ================================================================ HYPERLINKS ==

\usepackage[
  unicode=true,
%  breaklinks=true,
%  bookmarks=true,
%  pdfauthor={$author-meta$},
%  pdftitle={$title-meta$},
%  colorlinks=true,
%  citecolor=$if(citecolor)$$citecolor$$else$blue$endif$,
%  urlcolor=$if(urlcolor)$$urlcolor$$else$blue$endif$,
%  linkcolor=$if(linkcolor)$$linkcolor$$else$magenta$endif$,
%  pdfborder={0 0 0},
  hidelinks,
]{hyperref}

% don't use monospace font for urls
\urlstyle{same}

% =============================================================== PAGE LAYOUT ==

\usepackage{fancyhdr}
\pagestyle{fancy}
\pagenumbering{arabic}
\lhead{\itshape $title$}
\chead{}
\rhead{\itshape{\nouppercase{\leftmark}}}
\lfoot{v $version$}
\cfoot{}
\rfoot{\thepage}

% ==================================================================== COLORS ==

\usepackage[table]{xcolor}

% ==================================================================== FLOATS ==

% allow b and h for table* and figure*
\usepackage{dblfloatfix}

% preserve order among starred and unstarred tables/figures
\usepackage{fixltx2e}

\usepackage{float}

% ==================================================================== TABLES ==

% first we need to make pandoc output behave

%\usepackage{multicol}

%\usepackage{longtable}
\let\endhead\relax

%\usepackage{booktabs}
\let\toprule\hline
\let\bottomrule\hline
\let\midrule\hline

% and now the serious stuff

% breakable two-columns tables
\usepackage{xtab}

\usepackage{array}

\rowcolors{1}{gray!50}{gray}
\renewcommand*{\arraystretch}{1.5}

% transparency trick: ! gets the fill while > gets the content
\newcolumntype{O}{
  !{\pgfsetfillopacity{.2}}
  >{\leavevmode\pgfsetfillopacity{1}}
}

% content alignment
\newcolumntype{J}{>{}}
\newcolumntype{L}{>{\raggedright\arraybackslash}}
\newcolumntype{C}{>{\centering\arraybackslash}}
\newcolumntype{R}{>{\raggedleft\arraybackslash}}

% instead of erasing separators with @{} just compensate for them
\newcolumntype{S}[2]{#1{\dimexpr#2\linewidth-2\tabcolsep\relax}}

% cell alignment
\newcolumntype{T}[1]{S{p}{#1}}
\newcolumntype{M}[1]{S{m}{#1}}
\newcolumntype{B}[1]{S{b}{#1}}

\NewDocumentCommand{\NextTableColumns}{m}{\newcolumntype{N}{#1}}

\NewDocumentCommand{\BreakingTable}{}{
  \renewenvironment{VariaTable}
    {\begin{xtabular*}{\linewidth}{N}}
    {\end{xtabular*}}
}

\NewDocumentCommand{\FloatingTable}{O{htb}}{
  \renewenvironment{VariaTable}
    {\begin{table}[#1]\begin{xtabular*}{\linewidth}{N}}
    {\end{xtabular*}\end{table}}
}

\NewDocumentCommand{\SpanningTable}{O{tbp}}{
  \renewenvironment{VariaTable}
    {\begin{table*}[#1]\begin{xtabular*}{\linewidth}{N}}
    {\end{xtabular*}\end{table*}}
}

\newenvironment{VariaTable}{}{}
\BreakingTable


% hook to reset table configuration after each use
\AfterEndEnvironment{VariaTable}{\BreakingTable}

% =================================================================== FIGURES ==

\NewDocumentCommand{\FloatingFigure}{O{htb}}{
  \renewenvironment{VariaFigure}
    {\figure[#1]}
    {\endfigure}
}

\NewDocumentCommand{\SpanningFigure}{O{tbp}}{
  \renewenvironment{VariaFigure}
    {\begin{figure*}[#1]}
    {\end{figure*}}
}

\newenvironment{VariaFigure}{}{}
\FloatingFigure

%% hook to reset figure configuration after each use
\AfterEndEnvironment{VariaFigure}{\FloatingFigure}

%\usepackage{wrapfig}

%\begin{figure}[H]%\raggedleft
%\hspace{\dimexpr\linewidth-1.1\linewidth\relax}%
%\makebox[\linewidth][l]
%{\includegraphics[width=1.1\linewidth]{example-image-a}}
%\end{figure}

% automagic picture resizing
\usepackage{graphicx,grffile}
\newsavebox\ltmcbox
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% ================================================================ BACKGROUND ==

% temporary page color
\usepackage{pagecolor}
\pagecolor{yellow!30}

% background image
\usepackage{eso-pic}
\usepackage{tikz}
\usetikzlibrary{positioning}
\usetikzlibrary{patterns}

\AddToShipoutPicture{
%\tikz [overlay, remember picture] \node at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio]{assets/paper-bg-small.jpg}};
%\tikz [overlay, remember picture] \node at (current page.center) {\includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio]{assets/paper-bg.jpg}};
\tikz [overlay, remember picture] \draw [pattern=fivepointed stars,pattern color=orange!20] (current page.north west) rectangle (current page.south east);
}

% ================================================================= MICROTYPE ==

\usepackage{microtype}

% ============================================================= MAIN DOCUMENT ==

$if(title)$
\title{$title$$if(subtitle)$\\\vspace{0.5em}{\large $subtitle$}$endif$}
$endif$

$if(author)$
\author{$for(author)$$author$$sep$ \and $endfor$}
$endif$

\date{$date$}

\begin{document}
\maketitle
\tableofcontents
%\listoftables
%\listoffigures
$body$
\end{document}
